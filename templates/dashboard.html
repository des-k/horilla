{% load static basefilters horillafilters employee_filter i18n %} {% load tz %} {% now "Y-m-d" as current_date %}
{% load accessibility_filters %}
<link href="https://fonts.googleapis.com/css2?family=Lobster&display=swap" rel="stylesheet">

<div id="mainNav"></div>
<!-- End of Navigation -->
<style>
    .oh-card-dashboard--moveable {
        padding: 0 10px 20px 10px;
    }

    .oh-card-dashboard:not(.tile) {
        cursor: default;
        min-height: 425px;
    }

    .oh-dashboard__movable-cards {
        padding-right: 0;
    }

    .oh-card-dashboard--moveable {
        padding-right: 0;
        padding-bottom: 10px;
    }

    .progress {
        height: 20px;
        width: 110px;
        background-color: lightgrey;
        border: 2px solid #27C20C;
        border-radius: 5px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background-color: #27C20C;
        /* Set your desired progress bar color */
    }

    .progress-text {
        width: 100%;
        text-align: center;
    }

    .oh-modal_close--custom {
        border: none;
        background: none;
        font-size: 1.5rem;
        opacity: 0.7;
        position: absolute;
        top: 25px;
        right: 15px;
    }

    .container-heading {
        font-size: 18px;
        font-weight: bold;
        padding: 10px;
    }

    .oh-kanban-card__title {
        display: block;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid hsl(8deg 77% 56% / 40%);
        border-radius: 18px;
        margin-right: 10px;
        background-color: hsl(24.23deg 100% 58.24% / 52.94%);
    }

    .announcement_title {
        margin-bottom: 10px;
        padding: 8px;
        margin-right: 10px;
        text-decoration: none;
    }

    .page-wrapper {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        /* Center the modal */
        width: 80%;
        /* Adjust the width of the modal */
        height: 80%;
        /* Adjust the height of the modal */
        overflow: hidden;
        z-index: 1001;
        background: transparent;
        /* Ensure background is transparent */
        display: flex;
        justify-content: center;
        align-items: center;

    }

    .blurred-background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: cover;
        filter: blur(5px);
        opacity: 2;
        /* Adjust opacity level */
        z-index: 1000;
        /* Ensure it's behind the canvas */
    }
</style>

<div class="oh-wrapper">

    <!-- back button -->
    <div class="d-none mt-5" id="back_button" style="width: 10%">
        <a href="{% url 'home-page' %}" class="oh-btn oh-btn--secondary oh-btn--shadow ms-3">
            <ion-icon class="me-2 md hydrated" name="arrow-back-outline" role="img"
                aria-label="arrow-back-outline"></ion-icon>{% trans "Back" %}</a>
    </div>
    <!-- end of back button -->
    <div class="oh-dashboard row" id="dashboard" style="padding-bottom: 3.5rem;">


        <div class="oh-dashboard__left col-12 col-sm-12 col-md-12 col-lg-9">
            <div class="oh-dashboard__cards row">
                {% if perms.employee.view_employee %}
                    {% if "recruitment"|app_installed %}
                        <div class="col-12 col-sm-12 col-md-6 col-lg-4">
                            <div class="oh-card-dashboard oh-card-dashboard--success tile">
                                <a href="{% url 'candidate-view' %}?joining_date={{current_date}}"
                                    style="text-decoration: none">
                                    <div class="oh-card-dashboard__header">
                                        <span class="oh-card-dashboard__title">{% trans "New Joining Today" %}</span>
                                    </div>
                                    <div class="oh-card-dashboard__body">
                                        <div class="oh-card-dashboard__counts">
                                            <span class="oh-card-dashboard__count" hx-get="{% url 'joining-today-count' %}" hx-trigger="load">
                                                <div style="height: 67px;"></div>
                                            </span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="col-12 col-sm-12 col-md-6 col-lg-4">
                            <div class="oh-card-dashboard oh-card-dashboard oh-card-dashboard--warning tile">
                                <a href="{% url 'candidate-view' %}?scheduled_from={{first_day_of_week}}&scheduled_till={{last_day_of_week}}"
                                    style="text-decoration: none">
                                    <div class="oh-card-dashboard__header">
                                        <span class="oh-card-dashboard__title">{% trans "New Joining This Week" %}</span>
                                    </div>
                                    <div class="oh-card-dashboard__body">
                                        <div class="oh-card-dashboard__counts">
                                            <span class="oh-card-dashboard__count" hx-get="{% url 'joining-week-count' %}" hx-trigger="load">
                                                <div style="height: 67px;"></div>
                                            </span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    {% endif %}
                    <div class="col-12 col-sm-12 col-md-6 col-lg-4">
                        <a href="{% url 'employee-view' %}" style="text-decoration: none">
                            <div class="oh-card-dashboard oh-card-dashboard--neutral tile">
                                <div class="oh-card-dashboard__header">
                                    <span class="oh-card-dashboard__title">{% trans "Total Strength" %}</span>
                                </div>
                                <div class="oh-card-dashboard__body">
                                    <div class="oh-card-dashboard__counts">
                                        <span class="oh-card-dashboard__count" hx-get="{% url 'total-employees-count' %}"
                                            hx-trigger="load">
                                            <div style="height: 67px;"></div>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                {% endif %}
                <div class="oh-dashboard__movable-cards row mt-4" id="tileContainer">
                    {% include "dashboard_tile_container.html" %}
                </div>
            </div>
        </div>
        <div class="oh-dashboard__right col-12 col-sm-12 col-md-12 col-lg-3">
            <div class="oh-card-dashboard oh-card-dashboard--no-scale oh-card-dashboard--transparent mb-3">
                <div style="display: flex;align-items:center;justify-content:space-between;margin-right:20px">
                    <span class="oh-card-dashboard__title">{% trans "Announcements" %}</span>
                    {% if perms.base.add_announcement %}
                        <span>
                            <button id="addAnnouncement" style="display: inline-block;padding: 0px;
                            border-radius: 6px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            width: 50px;
                            height: 28px;" class="oh-btn oh-btn--secondary-outline float-end ms-3"
                                hx-get="{% url 'create-announcement' %}" hx-target="#objectCreateModalTarget"
                                hx-swap="innerHTML" data-toggle="oh-modal-toggle" data-target="#objectCreateModal"
                                title="{% trans 'Create Announcement' %}">
                                <ion-icon name="add-outline" class="m-0"></ion-icon>
                            </button>
                        </span>
                    {% endif %}
                </div>

                <hr>

                <div class="oh-card-dashboard__body" hx-get="{% url 'announcement-list' %}" hx-trigger="load"
                    id="announcementListCard">
                    <div class="animated-background"></div>
                </div>
            </div>
            {% if "leave"|app_installed %}
                {% if perms.leave.view_leaverequest or request.user|is_reportingmanager %}
                    <div class="oh-card-dashboard oh-card-dashboard--no-scale oh-card-dashboard--transparent mb-3">
                        <div class="oh-card-dashboard__header oh-card-dashboard__header--divider">
                            <span class="oh-card-dashboard__title">{% trans "On Leave" %}</span>
                        </div>
                        <div class="oh-card-dashboard__body" hx-get="{% url 'employee-leave' %}" hx-trigger="load"
                            style="height:300px;overflow-x: auto;">
                            <div class="animated-background"></div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
            {% if perms.employee.view_employeeworkinformation or request.user|is_reportingmanager %}
                <div class="oh-card-dashboard oh-card-dashboard--no-scale oh-card-dashboard--transparent">
                    <div class="oh-card-dashboard__header oh-card-dashboard__header--divider">
                        <span class="oh-card-dashboard__title">{% trans "Employee Work Information" %}</span>
                    </div>
                    <!-- Search bar -->
                    <div class="oh-search-bar mb-3">
                        <input type="text" hx-get="{% url 'emp-workinfo-complete' %}" hx-target="#pending"
                            hx-trigger="keyup  changed delay:0.3s" id="employeeSearch" name="search"
                            placeholder="Search Employee">
                    </div>
                    <div class="oh-card-dashboard__body" hx-get="{% url 'emp-workinfo-complete' %}" hx-trigger="load">
                        <div class="animated-background"></div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
<div class="oh-modal" id="sendMailModal" role="dialog" aria-labelledby="sendMailModal" aria-hidden="true">
    <div class="oh-modal__dialog">
        <div class="oh-modal__dialog-header">
            <span class="oh-modal__dialog-title" id="sendMailModalLabel">
                <h5>{% trans 'Send Mail' %}</h5>
            </span>
            <button class="oh-modal__close" aria-label="Close"><ion-icon name="close-outline"></ion-icon></button>
        </div>
        <div class="oh-modal__dialog-body" id="mail-content"></div>
    </div>
</div>

<div class="oh-modal" id="bigModal" role="dialog" aria-labelledby="bigModal" aria-hidden="true">
    <div class="oh-modal__dialog">
        <div class="oh-modal__dialog-header">
            <h2 class="oh-modal__dialog-title" id="">
                {% trans "Details" %}
            </h2>
            <button class="oh-modal__close" aria-label="Close">
                <ion-icon name="close-outline"></ion-icon>
            </button>
        </div>
        <div class="oh-modal__dialog-body oh-modal__dialog-relative" id="bigModalTarget"></div>
    </div>
</div>


<div class="oh-modal" id="editModal" role="dialog" aria-labelledby="editModal" aria-hidden="true">
    <div class="oh-modal__dialog">
        <div class="oh-modal__dialog-header">
            <h2 class="oh-modal__dialog-title" id="editModalLabel">
                {% trans "Add Asset Report" %}
            </h2>
            <button type="button" class="oh-modal_close--custom"
                onclick="$('#editModal').removeClass('oh-modal--show');">
                <ion-icon name="close-outline" role="img" aria-label="close outline"></ion-icon>
            </button>
        </div>
        <div class="oh-modal__dialog-body" id="editModalForm"></div>
    </div>
</div>

{% include "announcement_single_view.html" %}


</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="{% static 'dashboard/employeeChart.js' %}"></script>

{% if "leave"|app_installed %}
    <script src="{% static 'dashboard/onLeave.js' %}"></script>
    <script src="{% static 'dashboard/leaveChart.js' %}"></script>
{% endif %}

{% if "recruitment"|app_installed %}
    {% if perms.recruitment.view_recruitment or request.user|is_stagemanager %}
        <script src="{% static 'dashboard/recruitmentChart.js' %}"></script>
    {% endif %}
{% endif %}

{% if "attendance"|app_installed %}
    {% if perms.attendance.view_attendance or request.user|is_reportingmanager %}
        <script src="{% static 'dashboard/attendanceChart.js' %}"></script>
    {% endif %}
{% endif %}

{% if "onboarding"|app_installed %}
    <!-- onboarding dashboard -->
    <script src="{% static 'dashboard/onboardChart.js' %}"></script>
{% endif %}

{% if "pms"|app_installed %}
    <!-- PMS chart -->
    <script src="{% static 'src/dashboard/pmsChart.js' %}"></script>
{% endif %}

<!-- leave dashboard -->
Here is the clean, fixed code with English comments.

I have removed all the "Happy Birthday" animation code (which caused the error) and kept only the Dashboard Tile ordering logic so your dashboard remains functional.

Replace your entire old <script> block with this one:

HTML
<script>
    // --- SECTION 1: DASHBOARD TILE ORDERING LOGIC (Keep this) ---
    $(document).ready(function () {

        // Helper function to calculate the difference between two arrays
        function setDifference(arr1, arr2) {
            return arr2.filter(id => !arr1.includes(id));
        }

        // Default tile order if the user has never saved a preference
        const defaultTileOrder = [
            "notInYetId", "LeaveApprove", "shiftRequestApprove", "WorkTypeRequestApprove", "AttendanceValidate", "OTApprove",
            "LeaveAllocationApprove", "feedbackAnswer", "assetRequestApprove", "movable8", "pendingHours", "notoutYetId",
            "movable2", "movable3", "movable4", "movable1", "movable5", "movable6", "movable7", "movable9", "movable10", "movable11"
        ];

        // Get all current tile IDs present in the DOM
        const allCurrentTileIds = $(".oh-card-dashboard--moveable[id]").map(function () {
            return $(this).attr("id");
        }).get();

        // Check LocalStorage. If no order is saved, use the default one.
        if (!localStorage.getItem("tileOrder")) {
            localStorage.setItem("tileOrder", JSON.stringify(defaultTileOrder));
        } else {
            let storedIds = JSON.parse(localStorage.getItem("tileOrder")) || [];

            // Synchronization: Remove IDs that no longer exist, add new IDs that are missing
            const newTileIds = setDifference(storedIds, allCurrentTileIds);
            const missingTileIds = setDifference(allCurrentTileIds, storedIds);

            // Clean invalid IDs and append new ones
            const updatedOrder = storedIds.filter(id => allCurrentTileIds.includes(id));
            const finalOrder = [...updatedOrder, ...missingTileIds];

            localStorage.setItem("tileOrder", JSON.stringify(finalOrder));
        }

        // Main function to reorder the HTML elements based on the saved order
        function orderDashboardTile() {
            const parentContainer = $("#tileContainer");
            const orderIds = JSON.parse(localStorage.getItem("tileOrder")) || [];

            const sortedElements = [];
            for (const id of orderIds) {
                const element = $("#" + id);
                if (element.length) {
                    sortedElements.push(element);
                }
            }

            if (sortedElements.length) {
                parentContainer.empty();
                for (const element of sortedElements) {
                    parentContainer.append(element);
                }
            }
        }

        // Execute the reordering function on page load
        orderDashboardTile();

        // Event Listener: Save the new order whenever the user finishes dragging a tile
        $(".oh-card-dashboard--moveable").on("mouseup", function () {
            setTimeout(() => {
                const newOrder = $(".oh-card-dashboard--moveable").map(function () {
                    return $(this).attr("id");
                }).get();

                localStorage.setItem("tileOrder", JSON.stringify(newOrder));
            }, 10);
        });
    });

    // --- SECTION 2: GENERAL HELPER FUNCTIONS ---
    
    // Function to close the "New" tab/badge
    function closeNew(anchorElement) {
        $(anchorElement).parent().find('#newTab').hide();
    }
</script>

<script src="{% static 'build/js/dashboardDriver.js' %}"></script>

{% if not request.user.driverviewed_set.first or "dashboard" not in request.user.driverviewed_set.first.user_viewed %}
<script>
    runDriver()
</script>
{% endif %}

