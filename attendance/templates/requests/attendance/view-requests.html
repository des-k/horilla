{% extends 'index.html' %} {% block content %} {% load i18n %}
<style>
  .row-status--purple {
    border-left: 4px solid rgba(128, 128, 128, 0.482);
    border-radius: 5px;
  }
  .row-status--cyan {
    border-left: 4px solid cyan;
    border-radius: 5px;
  }
  .row-status--yellow {
    border-left: 4px solid yellowgreen;
    border-radius: 5px;
  }
  .diff-cell{
    background: rgba(255, 166, 0, 0.158);
  }
</style>

{% include 'requests/attendance/nav.html' %}
{% load basefilters %}
{% include 'filter_tags.html' %}
<div class="d-flex flex-row-reverse mb-1">
  <span class="me-5" hx-get='{% url "search-attendance-requests" %}?is_bulk_request=True' hx-target="#view-container" style="cursor: pointer">
    <span class="oh-dot oh-dot--small" style="background-color:rgb(31 122 220 / 48%)"></span>
    {% trans "Bulk-Requests" %}
  </span>
  <span class="me-3" hx-get='{% url "search-attendance-requests" %}?attendance_validated=false' hx-target="#view-container" style="cursor: pointer">
    <span class="oh-dot oh-dot--small" style="background-color:rgba(128, 128, 128, 0.482)"></span>
    {% trans "Not-Validated" %}
  </span>
  <span class="me-3" hx-get='{% url "search-attendance-requests" %}?attendance_validated=true' hx-target="#view-container" style="cursor: pointer">
    <span class="oh-dot oh-dot--small" style="background-color:yellowgreen"></span>
    {% trans "Validated" %}
  </span>
</div>
<div class="oh-wrapper ">
  <div class="oh-checkpoint-badge text-success mb-2" id="selectAllInstances" style="cursor: pointer;">
    {% trans "Select All Records" %}
  </div>
  <div class="oh-checkpoint-badge text-secondary mb-2" id="unselectAllInstances" style="cursor: pointer;display:none;">
    {% trans "Unselect All Records" %}
  </div>
  <div class="oh-checkpoint-badge mb-2" id="selectedInstances" data-ids="[]" data-clicked="" style="display:none;" >
  </div>
  <div class="oh-checkpoint-badge text-danger mb-2" id="selectedShow" >
  </div>
  <div class="oh-tabs">
    <ul class="oh-tabs__tablist">
      <li class="oh-tabs__tab oh-tabs__tab--active" data-target="#tab_1">
        {% trans "Requested Attendances" %}
      </li>
      <li class="oh-tabs__tab" data-target="#tab_2">
        {% trans "All Attendances" %}
      </li>
    </ul>  {% include "requests/attendance/request_lines.html" %}
  </div>
</div>

<button hidden hx-post="{% url "update-title" %}" hx-target="#objectDetailsModalTarget" id="updateTitleSpan"></button>
<div class="oh-activity-sidebar" id="activitySidebar" style="z-index:1000;">
  <div class="oh-activity-sidebar__body" id="commentContainer">
  </div>
</div>

<script>
    // --- 1. GLOBAL FUNCTION DEFINITION (Using window to prevent reference errors) ---
    
    // Attach function to window so it is accessible globally
    window.requestedAttendanceTickCheckboxes = function() {
        var ids = [];
        // Loop through checked checkboxes
        $(".attendance-request-checkbox:checked").each(function () {
            ids.push($(this).val());
        });

        // Show/Hide Bulk Action Buttons
        if (ids.length > 0) {
            $(".bulk-action-btn").removeClass("d-none").show();
        } else {
            $(".bulk-action-btn").addClass("d-none").hide();
        }
    };
    
    // Helper function for Select All logic
    window.addingRequestAttendanceIds = function() {
         if (typeof window.requestedAttendanceTickCheckboxes === 'function') {
             window.requestedAttendanceTickCheckboxes();
         }
    };
    // --------------------------------------------------

  $(document).ready(function () {
    
    // --- 2. EXECUTE ON LOAD ---
    // Use try-catch to ensure one error doesn't break the whole script
    try {
        if (typeof window.requestedAttendanceTickCheckboxes === "function") {
            window.requestedAttendanceTickCheckboxes();
        }
    } catch (e) {
        console.warn("Error running initial checkbox check:", e);
    }

    // Event Listener: Individual Checkbox Change
    $(document).on("change", ".attendance-request-checkbox", function () {
        window.requestedAttendanceTickCheckboxes();
    });

    // Event Listener: Select All Checkbox (Header)
    $(document).on("change", "#all-attendance-request", function () {
        var isChecked = $(this).is(":checked");
        $(".attendance-request-checkbox").prop("checked", isChecked).change();
    });

    // --- TAB SWITCHING LOGIC ---
    $('.oh-tabs__tab').on('click', function (e) {
        e.preventDefault();
        $('.oh-tabs__tab').removeClass('oh-tabs__tab--active');
        $(this).addClass('oh-tabs__tab--active');
        
        $('#tab_1, #tab_2').removeClass('oh-tabs__content--active');
        
        var target = $(this).data('target');
        $(target).addClass('oh-tabs__content--active');

        if (target === '#tab_1') {
            $('#selectAllInstances').show();
        } else {
            $('#selectAllInstances').hide();
        }
    });

    // Initial Tab State
    if ($('#tab_1').hasClass('oh-tabs__content--active')) {
        $('#selectAllInstances').show();
    } else {
        $('#selectAllInstances').hide();
    }
    
    // --- OTHER EVENT LISTENERS ---
    $(".requested-attendances-select-all").change(function () {
      setTimeout(function() {
          if (typeof window.addingRequestAttendanceIds === "function") {
             window.addingRequestAttendanceIds();
          }
      }, 500);
    });

    $("#selectAllInstances").click(function () {
      if (typeof selectAllReqAttendance === "function") {
         selectAllReqAttendance();
      }
    });

    $("#unselectAllInstances").click(function () {
      if (typeof unselectAllReqAttendance === "function") {
         unselectAllReqAttendance();
      }
    });

  });

  // --- 3. OTHER HELPER FUNCTIONS (Attached to window for safety) ---
  
  window.enlargeImage = function(src, $element) {
      $(".enlargeImageContainer").empty()
      var enlargeImageContainer = $element.parents().closest("li").find(".enlargeImageContainer")
      enlargeImageContainer.empty()
      var style = 'width:100%; height:90%; box-shadow: 0 10px 10px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.2); background:white'
      var enlargedImage = $('<iframe>').attr({ src: src, style: style })
      var name = $('<span>').text(src.split('/').pop().replace(/_/g, ' '))
      enlargeImageContainer.append(enlargedImage)
      enlargeImageContainer.append(name)
      setTimeout(function () {
          enlargeImageContainer.show()
          var iframe = document.querySelector('iframe').contentWindow
          var iframe_document = iframe.document
          var iframe_image = iframe_document.getElementsByTagName('img')[0]
          $(iframe_image).attr('style', 'width:100%; height:100%;')
      }, 100)
  }

  window.hideEnlargeImage = function() {
      var enlargeImageContainer = $('.enlargeImageContainer')
      enlargeImageContainer.empty()
  }

  $(document).on('click', function (event) {
      if (!$(event.target).closest('#enlargeImageContainer').length) {
          window.hideEnlargeImage()
      }
  })

  window.submitForm = function(elem) {
    $(elem).siblings(".add_more_submit").click();
  }

  window.dynamicBatchAttendance = function(element){
    var batch = element.val()
    if (batch === 'dynamic_create'){
      var parentForm = element.parents().closest("form");
      var previous_url = parentForm.attr('data-url');
      // clear hx-vals
      $('#dynamicCreateBatchAttendanceSpan').attr("hx-vals",`{"previous_url":"${previous_url}"}`)
      $('#dynamicCreateBatchAttendanceSpan').click();
      // unselect the chosen value
      element.val('').change();
    }
  }

  window.batchTitleChange = function(element){
    console.log(element)
    var title = $(element).val()
    var batchId = $(element).data('id')
    $('#updateTitleSpan').attr("hx-vals",`{"batch_id":"${batchId}","title":"${title}"}`)
    $('#updateTitleSpan').click()
  }
</script>

{% endblock content %}
